// @ts-nocheck
function setupCustomers(){STATE.initDropdowns=!1;let e=[{formatter:"rowSelection",titleFormatter:"rowSelection",field:"rowSelection",hozAlign:"center",headerSort:!1,width:50,frozen:!0},{title:"MÃ KH",field:"customerCode",required:!0},{title:"TÊN SALES",field:"salesName",required:!0},{title:"NGUỒN KH",field:"customerSource",required:!0,input:"select"},{title:"MÔ HÌNH KD",field:"businessModel",required:!0,input:"select"},{title:"NHÓM NGÀNH KD",field:"industryGroup",required:!0,input:"select"},{title:"TÊN KH",field:"customerName",required:!0},{title:"ĐỊA CHỈ",field:"address",required:!0},{title:"PHƯỜNG/ XÃ/ ĐẶC KHU",field:"wardCommuneSpecialZone",required:!0,input:"select"},{title:"TỈNH/ THÀNH",field:"provinceCity",required:!0,input:"select"},{title:"MÃ SỐ THUẾ",field:"taxCode"},{title:"SĐT TỔ CHỨC",field:"organizationPhone"},{title:"NGƯỜI LH",field:"contactPerson"},{title:"SỐ DI ĐỘNG",field:"mobileNumber"},{title:"EMAIL",field:"email"},{title:"MIỀN",field:"region",input:"select"},{title:"VÙNG ĐỊA LÝ",field:"geographicalArea",input:"select"},{title:"Địa chỉ giao hàng",field:"shippingAddress",input:"select"},{title:"Người nhận",field:"recipient"},{title:"Di động",field:"recipientMobile"},{title:"Ghi chú về khách hàng",field:"customerNotes",editor:"textarea"},{title:"TRẠNG THÁI KH",field:"customerStatus",input:"select"},{title:"Account/ Lần cuối chỉnh sửa",field:"accountLastModified"}];function t(e,...t){$(`#${e}`).off("change").on("change",(function(){const e=$(this).val();t.forEach((t=>{$(`#${t}`).val(e)}))}))}function l(e,t="red"){$(`label[for="${e}"]`).css("color",t)}function a(){let e=!0;const t=$("#customerName").val().trim(),l=$("#address").val().trim(),a=$("#taxCode").val().trim();STATE.customerData.find((e=>String(e.customerName).trim()===t&&String(e.address).trim()===l&&String(e.taxCode).trim()===a))&&(Swal.fire("Thông báo","Khách hàng với tên, địa chỉ và mã số thuế này đã tồn tại.","error"),e=!1);const o=$("#email").val().trim();return o&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o)&&(Swal.fire("Thông báo","Email không hợp lệ.","error"),e=!1),e}function o(e){STATE.customerData=function(e){let t=[],l=e.slice(1).filter((e=>e[0]&&e[1]))||[],a=STATE.customerTable.getColumns().filter((e=>"rowSelection"!==e.getField()));return l.forEach((e=>{let l={};a.forEach(((t,a)=>{const o=t.getField();l[o]=e[a]})),t.push(l)})),t}(e),STATE.customerTable.setData(STATE.customerData)}function n(t={}){$("select").selectpicker(),STATE.initDropdowns||function(){try{const e=STATE.customerConfig,t={customerSource:"NGUỒN KH",businessModel:"MÔ HÌNH HĐ",industryGroup:"NHÓM NGÀNH HĐ",wardCommuneSpecialZone:"PHƯỜNG/ XÃ/ ĐẶC KHU",provinceCity:"TỈNH THÀNH",region:"MIỀN",geographicalArea:"VÙNG ĐỊA LÝ",customerStatus:"TRẠNG THÁI KH"};Object.keys(t).forEach((l=>{const a=t[l];console.log(a,l);const o=e[a+"_unique"],n=$("#"+l);n.empty(),n.append('<option value="">Chọn...</option>'),o.forEach((e=>{n.append(`<option value="${e}">${e}</option>`)}))})),$("select").selectpicker("refresh"),STATE.initDropdowns=!0}catch(e){console.error("Error populating dropdowns:",e),Swal.fire("Thông báo","Không thể tải cấu hình khách hàng.","error")}}();const l=localStorage.getItem("savedUsername")||"";t.salesName||setTimeout((()=>{$("#salesName").val(l)}),100),t.customerCode&&$("#customerCode").val(t.customerCode);const n=(new Date).toLocaleString();$("#accountLastModified").val(`${l} / ${n}`),Object.keys(t).forEach((l=>{let a=e.find((e=>e.field==l));a&&"select"===a.input?$("#"+l).selectpicker("val",t[l]):$("#"+l).val(t[l])})),t.shippingAddress&&$("#shippingAddress").val(t.shippingAddress),$("#customer-modal").modal("show"),$("#customer-form").off("submit").on("submit",(async function(e){if(showLoading(),e.preventDefault(),!a())return void hideLoading();const l=new FormData(e.target),n=Object.fromEntries(l),i=[localStorage.getItem("savedUsername")||"",(new Date).toLocaleString("vi-vn",{timeZone:"Asia/Ho_Chi_Minh"})].join(", "),s=[n.salesName||"",n.customerSource||"",n.businessModel||"",n.industryGroup||"",n.customerName||"",n.address||"",n.wardCommuneSpecialZone||"",n.provinceCity||"",n.taxCode||"",n.organizationPhone||"",n.contactPerson||"",n.mobileNumber||"",n.email||"",n.region||"",n.geographicalArea||"",n.shippingAddress||"",n.recipient||"",n.recipientMobile||"",n.customerNotes||"",n.customerStatus||"",i];try{let e;e=t.customerCode?await sendRequest({action:"khachhang.update",id:n.customerCode,values:s}):await sendRequest({action:"khachhang.create",id:null,values:s}),o(e.data),$("#customer-modal").modal("hide"),hideLoading(),Swal.fire("Thành công!","Khách hàng đã được lưu.","success")}catch(e){hideLoading(),console.error("Error saving customer:",e),Swal.fire("Lỗi","Không thể lưu khách hàng. Vui lòng thử lại.","error")}}))}e.forEach((e=>{e.required&&$(`#${e.field}`).on("input change",(function(){const t=$(this).val();t&&String(t).trim()?l(e.field,"black"):l(e.field,"red")})),["customerName","address","taxCode"].includes(e.field)&&$(`#${e.field}`).on("input change",(function(){a()}))})),$("#email").on("input change",(function(){const e=$(this).val();e&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?l("email","red"):l("email","black")})),function(){$(".table-wrapper").length||$("#app").html('\n                <div class="table-wrapper" style="overflow:auto;">\n                </div>\n            '),$(".table-wrapper").empty(),$(".table-wrapper").html(`\n            <h4 id="table-title">${STATE.activePage.label}</h4>\n            <div id="${STATE.activePage.key}-table"></div>\n        `);const t=new Tabulator("#customers-table",{data:[],columns:e,layout:"fitData",responsiveLayout:"collapse",responsiveLayoutCollapseStartOpen:!1,selectable:"checkbox",movableColumns:!0,resizableColumns:!0,tooltips:!0,height:"600px",theme:"bootstrap5"});STATE.customerTable=t,createTableControls(t,(function(){let t={};e.forEach((e=>{t[e.field]=""})),n(t)}),(function(){const e=t.getSelectedRows();1===e.length?n(e[0].getData()):Swal.fire("Vui lòng chọn một dòng để sửa.")}),(function(){const e=t.getSelectedRows();e.length>0?Swal.fire({title:"Thông báo",text:"Bạn chắc chắn muốn xoá các dòng đã chọn",icon:"warning",showCancelButton:!0,confirmButtonText:"Đồng ý"}).then((async t=>{if(t.isConfirmed){o((await sendRequest({action:"khachhang.delete",ids:e.map((e=>e.getData().customerCode))})).data),Swal.fire("Thông báo","Các khách hàng đã chọn đã được xóa.","success")}})):Swal.fire("Vui lòng chọn ít nhất một hàng để xóa.")}))}(),setTimeout((()=>{!async function(e=!1){showLoading();let[t,l]=[STATE.customerSheetData,STATE.customerSheetConfig];e&&([t,l]=await Promise.all([sendRequest({action:"khachhang.read"}),sendRequest({action:"getCustomersConfig"})]),t=t.data,l=l.data),STATE.customerData=[],STATE.customerConfig=arrayToConfig(l||[]),o(t),hideLoading()}()}),250),$("#customer-modal").remove(),$("body").append('\n            <div class="modal fade" id="customer-modal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">\n                <div class="modal-dialog modal-xl">\n                    <div class="modal-content">\n                        <div class="modal-header">\n                            <h5 class="modal-title" id="customerModalLabel">Thêm/Sửa Khách Hàng</h5>\n                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                        </div>\n                        <div class="modal-body">\n                            <form id="customer-form">\n                                <div class="row">\n                                    <div class="col-md-4 mb-3">\n                                        <label for="customerCode" class="form-label">MÃ KH</label>\n                                        <input type="text" class="form-control" id="customerCode" name="customerCode" readonly>\n                                    </div>\n                                    <div class="col-md-4 mb-3">\n                                        <label for="salesName" class="form-label">TÊN SALES</label>\n                                        <input type="text" class="form-control" id="salesName" name="salesName" readonly>\n                                    </div>\n                                    <div class="col-md-4 mb-3">\n                                        <label for="customerSource" class="form-label">NGUỒN KH</label>\n                                        <select data-live-search="true" class="selectpicker d-grid" id="customerSource" name="customerSource"></select>\n                                    </div>\n                                </div>\n                                <div class="row">\n                                    <div class="col-md-4 mb-3">\n                                        <label for="businessModel" class="form-label">MÔ HÌNH KD</label>\n                                        <select data-live-search="true" class="selectpicker d-grid" id="businessModel" name="businessModel"></select>\n                                    </div>\n                                    <div class="col-md-4 mb-3">\n                                        <label for="industryGroup" class="form-label">NHÓM NGÀNH KD</label>\n                                        <select data-live-search="true" class="selectpicker d-grid" id="industryGroup" name="industryGroup"></select>\n                                    </div>\n                                    <div class="col-md-4 mb-3">\n                                        <label for="customerName" class="form-label">TÊN KH</label>\n                                        <input type="text" class="form-control" id="customerName" name="customerName">\n                                    </div>\n                                </div>\n                                <div class="row">\n                                    <div class="col-md-4 mb-3">\n                                        <label for="address" class="form-label">ĐỊA CHỈ</label>\n                                        <input type="text" class="form-control" id="address" name="address">\n                                    </div>\n                                    <div class="col-md-4 mb-3">\n                                        <label for="wardCommuneSpecialZone" class="form-label">PHƯỜNG/ XÃ/ ĐẶC KHU</label>\n                                        <select data-live-search="true" class="selectpicker d-grid" id="wardCommuneSpecialZone" name="wardCommuneSpecialZone"></select>\n                                    </div>\n                                    <div class="col-md-4 mb-3">\n                                        <label for="provinceCity" class="form-label">TỈNH/ THÀNH</label>\n                                        <select data-live-search="true" class="selectpicker d-grid" id="provinceCity" name="provinceCity"></select>\n                                    </div>\n                                </div>\n                                <div class="row">\n                                    <div class="col-md-4 mb-3">\n                                        <label for="region" class="form-label">MIỀN</label>\n                                        <select data-live-search="true" class="selectpicker d-grid" id="region" name="region"></select>\n                                    </div>\n                                    <div class="col-md-4 mb-3">\n                                        <label for="geographicalArea" class="form-label">VÙNG ĐỊA LÝ</label>\n                                        <select data-live-search="true" class="selectpicker d-grid" id="geographicalArea" name="geographicalArea"></select>\n                                    </div>\n                                    <div class="col-md-4 mb-3">\n                                        <label for="taxCode" class="form-label">MÃ SỐ THUẾ</label>\n                                        <input type="text" class="form-control" id="taxCode" name="taxCode">\n                                    </div>\n                                </div>\n                                <div class="row">\n                                    <div class="col-md-4 mb-3">\n                                        <label for="organizationPhone" class="form-label">SĐT TỔ CHỨC</label>\n                                        <input type="text" class="form-control" id="organizationPhone" name="organizationPhone">\n                                    </div>\n                                    <div class="col-md-4 mb-3">\n                                        <label for="contactPerson" class="form-label">NGƯỜI LH</label>\n                                        <input type="text" class="form-control" id="contactPerson" name="contactPerson">\n                                    </div>\n                                    <div class="col-md-4 mb-3">\n                                        <label for="mobileNumber" class="form-label">SỐ DI ĐỘNG</label>\n                                        <input type="text" class="form-control" id="mobileNumber" name="mobileNumber">\n                                    </div>\n                                </div>\n                                <div class="row">\n                                    <div class="col-md-4 mb-3">\n                                        <label for="email" class="form-label">EMAIL</label>\n                                        <input type="email" class="form-control" id="email" name="email">\n                                    </div>\n                                    <div class="col-md-4 mb-3">\n                                        <label for="shippingAddress" class="form-label">ĐỊA CHỈ GIAO HÀNG</label>\n                                        <input type="text" class="form-control" id="shippingAddress" name="shippingAddress">\n                                    </div>\n                                    <div class="col-md-4 mb-3">\n                                        <label for="recipient" class="form-label">NGƯỜI NHẬN</label>\n                                        <input type="text" class="form-control" id="recipient" name="recipient">\n                                    </div>\n                                </div>\n                                <div class="row">\n                                    <div class="col-md-4 mb-3">\n                                        <label for="recipientMobile" class="form-label">DI ĐỘNG</label>\n                                        <input type="text" class="form-control" id="recipientMobile" name="recipientMobile">\n                                    </div>\n                                    <div class="col-md-4 mb-3">\n                                        <label for="customerStatus" class="form-label">TRẠNG THÁI KH</label>\n                                        <select data-live-search="true" class="selectpicker d-grid" id="customerStatus" name="customerStatus"></select>\n                                    </div>\n                                    <div class="col-md-4 mb-3">\n                                        <label for="accountLastModified" class="form-label">ACCOUNT/ LẦN CUỐI CHỈNH SỬA</label>\n                                        <input type="text" class="form-control" id="accountLastModified" name="accountLastModified" readonly>\n                                    </div>\n                                </div>\n                                <div class="mb-3">\n                                    <label for="customerNotes" class="form-label">GHI CHÚ VỀ KHÁCH HÀNG</label>\n                                    <textarea class="form-control" id="customerNotes" name="customerNotes" rows="3"></textarea>\n                                </div>\n                            </form>\n                        </div>\n                        <div class="modal-footer">\n                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>\n                            <button type="submit" form="customer-form" class="btn btn-primary">Lưu</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        '),$("select").selectpicker(),$("#wardCommuneSpecialZone").on("change",(function(){const e=$(this).val();console.log(e);let{provinceCity:t,geographicalArea:l,region:a}=function(e){let t=STATE.customerConfig["PHƯỜNG/ XÃ/ ĐẶC KHU"]?.indexOf(e);return console.log(t),console.log(STATE.customerConfig["TỈNH THÀNH"]?.[t]),void 0!==t&&t>=0?{provinceCity:STATE.customerConfig["TỈNH THÀNH"]?.[t]||"",region:STATE.customerConfig["MIỀN"]?.[t]||"",geographicalArea:STATE.customerConfig["VÙNG ĐỊA LÝ"]?.[t]||""}:{}}(e)||{},o=$("#address").val()||"";$("#provinceCity").selectpicker("val",t||""),$("#geographicalArea").selectpicker("val",l||""),$("#region").selectpicker("val",a||"");let n=[o,e,t].join(", ");$("#shippingAddress").val(n)})),t("customerName","contactPerson","recipient"),t("organizationPhone","mobileNumber","recipientMobile"),t("address","shippingAddress")}